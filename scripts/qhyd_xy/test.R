###################################################
# Title: visualize QHYD XY-slice Rscript 
# Author: Gaku YAMANO
# Date: 2025/08/23
###################################################

# load packages
library(ncdf4)
library(fields)
source("../../config.R")

#######################################################
#################### Setting items ####################
#######################################################
# Specify the color palette
QHYD_palette <- colorRampPalette(c("white", "blue", 
                                   "green", "yellow", 
                                   "orange", "red"))(500)

# --- 追加: 可視化したい高度を指定 [km] ---
target_z_km <- 3.0

############################################################
#################### Processing Part #######################
############################################################
ncin <- nc_open(input_file)
alltimes <- ncvar_get(ncin, "time")
x <- ncvar_get(ncin, "x")
y <- ncvar_get(ncin, "y")
z <- ncvar_get(ncin, "z") # Z座標を読み込む

# --- 変更点: QHYDを4次元変数として読み込む ---
QHYD <- ncvar_get(ncin, "QHYD", collapse_degen = FALSE)
nc_close(ncin)

# Data processing
QHYD_min <- min(QHYD, na.rm=TRUE)
QHYD_max <- max(QHYD, na.rm=TRUE)
# --- 変更点: 4次元配列の時間次元は4番目 ---
dimnames(QHYD)[[4]] <- alltimes

x_km <- x * 10^(-3)
y_km <- y * 10^(-3) 
z_km <- z * 10^(-3)

# --- 追加: 指定した高度に最も近いZのインデックスを見つける ---
center_z_index <- which.min(abs(z_km - target_z_km))

# make plot function
plot_QHYD_slice <- function(time_val, slice_data) {
  
  base_filename <- paste("QHYD_XY.", sprintf("%05d", as.numeric(time_val)), ".pdf", sep = "")
  pdf_filename <- file.path(output_dir, base_filename)
  
  pdf(pdf_filename, width = pdf_width, height = pdf_height)
  
  # plot contour
  fields::image.plot(x_km, y_km, slice_data,
                     col = QHYD_palette,
                     zlim = c(QHYD_min, QHYD_max),
                     # --- 変更点: タイトルに高度情報を追加 ---
                     main = paste("Total Hydrometeors at Z =", z_km[center_z_index], "km (Time =", time_val, "s)"),
                     xlab = "X [km]",
                     ylab = "Y [km]", 
                     xaxt = "n",
                     yaxt = "n",
                     asp = 1
  )
  
  # plot axis
  x_ticks <- pretty(range(x_km), n = 10) 
  axis(side = 1, at = x_ticks, labels = sprintf("%.1f", x_ticks))
  y_ticks <- pretty(range(y_km), n = 8) 
  axis(side = 2, at = y_ticks, labels = sprintf("%.1f", y_ticks), las = 1)
  
  # close PDF device
  dev.off()
}

# plot processing
dir.create(output_dir, showWarnings = FALSE, recursive = TRUE)

if (output_alltime) {
  for (time in alltimes) {
    cat(sprintf("processing time = %s [s]\n", time))
    # --- 変更点: 4次元配列からZ断面を切り出す ---
    QHYD_slice <- QHYD[, , center_z_index, as.character(time)]
    plot_QHYD_slice(time_val = time, slice_data = QHYD_slice)
  }
} else {
  last_time <- tail(alltimes, 1)
  cat(sprintf("processing last time = %s [s]\n", last_time))
  # --- 変更点: 4次元配列からZ断面を切り出す ---
  QHYD_slice <- QHYD[, , center_z_index, as.character(last_time)]
  plot_QHYD_slice(time_val = last_time, slice_data = QHYD_slice)
}

cat(paste("All plots saved in '", output_dir, "' directory.\n", sep=""))
